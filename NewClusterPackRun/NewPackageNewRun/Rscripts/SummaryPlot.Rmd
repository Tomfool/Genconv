---
title: "SummaryPlot"
author: "Xiang Ji"
date: "December 29, 2014"
output: html_document
---

This R script is used for generating summary plot for the Geneconv project

1, Read in tables
```{r}
rm(list=ls())  # clean up workspace
#path <- "/Users/xji3/Genconv/NewClusterPackRun/NewPackageNewRun/OldResults01152015/"
path <- "/Users/xji3/Genconv/NewClusterPackRun/NewPackageNewRun/OldResults03112015/"
#path <- "G:/Geneconv/NewClusterPackRun/NewPackageNewRun/"
#HKY_clock_summary <- "HKY_clock_summary"
summary.list <- c( "HKY_nonclock_summary",
                  "HKY_clock_summary",
                  "MG94_clock_summary",
                  "MG94_nonclock_summary", 
                  "Force_HKY_clock_summary", 
                  "Force_MG94_clock_summary", 
                  "Force_MG94_nonclock_summary",
                 "Force_HKY_nonclock_summary"
                  )
#summary.list <- c("Force_MG94_clock_summary")
for (target.summary in summary.list){
  summary_file <- paste(path, target.summary, '.txt', sep = '')
  all <- readLines(summary_file, n = -1)
  col.names <- strsplit(all[1], ' ')[[1]][-1]
  row.names <- strsplit(all[length(all)], ' ')[[1]][-1]
  summary_mat <- as.matrix(read.table(summary_file, 
                                        row.names = row.names, 
                                        col.names = col.names))
  assign(target.summary, summary_mat)
}

# read in directional model summary
path.dir <- "/Users/xji3/Genconv/NewClusterPackRun/NewPackageNewRun/"
for (target.summary in summary.list){
  summary_file <- paste(path.dir, "Dir_" , target.summary, '.txt', sep = '')
  all <- readLines(summary_file, n = -1)
  col.names <- strsplit(all[1], ' ')[[1]][-1]
  row.names <- strsplit(all[length(all)], ' ')[[1]][-1]
  summary_mat <- as.matrix(read.table(summary_file, 
                                        row.names = row.names, 
                                        col.names = col.names))
  assign(paste("Dir_", target.summary, sep = ''), summary_mat)
  write.table(gsub("_", ".", paste("Dir_", target.summary, sep = '')), 
              paste(path.dir, "Dir_", target.summary, sep = ''))
}

```

Now generate summary file of only pairs that have all cases finished in HKY or MG94 models.

```{r}
# HKY
HKY.pair.names <- intersect(intersect(intersect(colnames(HKY_clock_summary), 
                            colnames(HKY_nonclock_summary)),
                            colnames(Force_HKY_clock_summary)),
                            colnames(Force_HKY_nonclock_summary))
HKY.clock.filtered <- HKY_clock_summary[, HKY.pair.names]
HKY.nonclock.filtered <- HKY_nonclock_summary[, HKY.pair.names]
HKY.Force.clock.filtered <- Force_HKY_clock_summary[, HKY.pair.names]
HKY.Force.nonclock.filtered <- Force_HKY_nonclock_summary[, HKY.pair.names]

write.table(HKY.clock.filtered, paste( path, "HKY_clock_filtered", sep = ""))
write.table(HKY.nonclock.filtered, paste( path, "HKY_nonclock_filtered", sep = ""))
write.table(HKY.Force.clock.filtered, paste( path, "HKY_Force_clock_filtered", sep = ""))
write.table(HKY.Force.nonclock.filtered, paste( path, "HKY_Force_nonclock_filtered", sep = ""))



# MG94
MG94.pair.names <- intersect(intersect(intersect(colnames(MG94_clock_summary), 
                            colnames(MG94_nonclock_summary)),
                            colnames(Force_MG94_clock_summary)),
                            colnames(Force_MG94_nonclock_summary))
MG94.clock.filtered <- MG94_clock_summary[, MG94.pair.names]
MG94.nonclock.filtered <- MG94_nonclock_summary[, MG94.pair.names]
MG94.Force.clock.filtered <- Force_MG94_clock_summary[, MG94.pair.names]
MG94.Force.nonclock.filtered <- Force_MG94_nonclock_summary[, MG94.pair.names]

write.table(MG94.clock.filtered, paste( path, "MG94_clock_filtered", sep = ""))
write.table(MG94.nonclock.filtered, paste( path, "MG94_nonclock_filtered", sep = ""))
write.table(MG94.Force.clock.filtered, paste( path, "MG94_Force_clock_filtered", sep = ""))
write.table(MG94.Force.nonclock.filtered, paste( path, "MG94_Force_nonclock_filtered", sep = ""))
```


Now analyze the results

First, show the loglikelihood improvement for each model with/without tau

```{r}
# HKY nonclock
(HKY.nonclock.filtered - HKY.Force.nonclock.filtered)[2,]
# HKY clock
(HKY.clock.filtered - HKY.Force.clock.filtered)[2,]
# # MG94 nonclock
(MG94.nonclock.filtered - MG94.Force.nonclock.filtered)[2,]
# # MG94 clock
(MG94.clock.filtered - MG94.Force.clock.filtered)[2,]
```

Then, show the edge specific tau estimates (posterior expected number of geneconv events / posterior expected time in heterogeneous states of each branch)

```{r}
HKY.nonclock.filtered[21:32, ]
```

Now plot Total blen v.s. Tau into different groups (differ by color)

HKY nonclock case
```{r}
plot(colSums(HKY.Force.nonclock.filtered[9:20, ]), HKY.nonclock.filtered[8, ],
     type = "n", xlab = "Total branch length", ylab = "Tau" )
col.color <- rep("black", dim(HKY.nonclock.filtered)[2])
col.color[(HKY.nonclock.filtered - HKY.Force.nonclock.filtered)[2,] < 50] <- "red"
points(x = colSums(HKY.Force.nonclock.filtered[9:20, ]), y = HKY.nonclock.filtered[8, ],
       type = "p", col = col.color, bg = col.color)
legend("topright", c("lnL improvement > 50", "lnL improvement < 50"),
       lty = c(1, 1), 
       lwd = c(2.5, 2.5),
       col = c("black", "red"))
title("HKY nonclock")
```

HKY clock case
```{r}
plot(colSums(HKY.Force.clock.filtered[9:20, ]), HKY.clock.filtered[8, ],
     type = "n", xlab = "Total branch length", ylab = "Tau" )
col.color <- rep("black", dim(HKY.clock.filtered)[2])
col.color[(HKY.clock.filtered - HKY.Force.clock.filtered)[2,] < 50] <- "red"
points(x = colSums(HKY.Force.clock.filtered[9:20, ]), y = HKY.clock.filtered[8, ],
       type = "p", col = col.color, bg = col.color)
legend("topright", c("lnL improvement > 50", "lnL improvement < 50"),
       lty = c(1, 1), 
       lwd = c(2.5, 2.5),
       col = c("black", "red"))
title("HKY clock")
```

MG94 nonclock case
```{r}
improvement.lmt <- 20
plot(colSums(MG94.Force.nonclock.filtered[10:21, ]), MG94.nonclock.filtered[8, ],
     type = "n", xlab = "Total branch length", ylab = "Tau" )
col.color <- rep("black", dim(MG94.nonclock.filtered)[2])
col.color[(MG94.nonclock.filtered - MG94.Force.nonclock.filtered)[2,] < improvement.lmt] <- "red"
points(x = colSums(MG94.Force.nonclock.filtered[10:21, ]), y = MG94.nonclock.filtered[8, ],
       type = "p", col = col.color, bg = col.color)
legend("topright", 
       c(paste("lnL improvement > ", toString(improvement.lmt), sep = ""),
         paste("lnL improvement < ", toString(improvement.lmt), sep = "")),
       lty = c(1, 1), 
       lwd = c(2.5, 2.5),
       col = c("black", "red"))
title("MG94 nonclock")
```

MG94 clock case
```{r}
improvement.lmt <- 20
plot(colSums(MG94.Force.clock.filtered[10:21, ]), MG94.clock.filtered[8, ],
     type = "n", xlab = "Total branch length", ylab = "Tau" )
col.color <- rep("black", dim(MG94.clock.filtered)[2])
col.color[(MG94.clock.filtered - MG94.Force.clock.filtered)[2,] < improvement.lmt] <- "red"
points(x = colSums(MG94.Force.clock.filtered[10:21, ]), y = MG94.clock.filtered[8, ],
       type = "p", col = col.color, bg = col.color)
legend("topright", 
       c(paste("lnL improvement > ", toString(improvement.lmt), sep = ""),
         paste("lnL improvement < ", toString(improvement.lmt), sep = "")),
       lty = c(1, 1), 
       lwd = c(2.5, 2.5),
       col = c("black", "red"))
title("MG94 clock")
```

Now see if the pairs red in HKY are also red in MG94

nonclock case
```{r}
HKY.pair.names[(HKY.nonclock.filtered - HKY.Force.nonclock.filtered)[2,] < 50]
MG94.pair.names[(MG94.nonclock.filtered - MG94.Force.nonclock.filtered)[2,] < improvement.lmt]
```

Only 3 pairs show up in both: YLR406C_YDL075W, YIL057C_YER067W, YDR438W_YML018C.


clock case
```{r}
HKY.pair.names[(HKY.clock.filtered - HKY.Force.clock.filtered)[2,] < 50]
MG94.pair.names[(MG94.clock.filtered - MG94.Force.clock.filtered)[2,] < improvement.lmt]
```

=========================================


Now plot Total blen v.s. Tau into different groups (differ by lnL improvement per site)

HKY nonclock case
```{r}
plot(colSums(HKY.Force.nonclock.filtered[9:20, ]), HKY.nonclock.filtered[8, ],
     type = "n", xlab = "Total branch length", ylab = "Tau" )
col.color <- rep("black", dim(HKY.nonclock.filtered)[2])
col.color[((HKY.nonclock.filtered - HKY.Force.nonclock.filtered)[2,] /  HKY.nonclock.filtered[1, ]) < 0.06] <- "red"
points(x = colSums(HKY.Force.nonclock.filtered[9:20, ]), y = HKY.nonclock.filtered[8, ],
       type = "p", col = col.color, bg = col.color)
legend("topright", c("lnL improvement per site > 0.06",
                     "lnL improvement per site < 0.06"),
       lty = c(1, 1), 
       lwd = c(2.5, 2.5),
       col = c("black", "red"))
title("HKY nonclock")

# lnL improvement per site
((HKY.nonclock.filtered - HKY.Force.nonclock.filtered)[2,] /  HKY.nonclock.filtered[1, ])
```

HKY clock case
```{r}
plot(colSums(HKY.Force.clock.filtered[9:20, ]), HKY.clock.filtered[8, ],
     type = "n", xlab = "Total branch length", ylab = "Tau" )
col.color <- rep("black", dim(HKY.clock.filtered)[2])
col.color[((HKY.clock.filtered - HKY.Force.clock.filtered)[2,] /  HKY.clock.filtered[1, ]) < 0.06] <- "red"
points(x = colSums(HKY.Force.clock.filtered[9:20, ]), y = HKY.clock.filtered[8, ],
       type = "p", col = col.color, bg = col.color)
legend("topright", c("lnL improvement per site > 0.06",
                     "lnL improvement per site < 0.06"),
       lty = c(1, 1), 
       lwd = c(2.5, 2.5),
       col = c("black", "red"))
title("HKY clock")

# lnL improvement per site
((HKY.clock.filtered - HKY.Force.clock.filtered)[2,] /  HKY.clock.filtered[1, ])
```

MG94 nonclock case
```{r}
improvement.lmt <- 0.16
plot(colSums(MG94.Force.nonclock.filtered[10:21, ]), MG94.nonclock.filtered[8, ],
     type = "n", xlab = "Total branch length", ylab = "Tau" )
col.color <- rep("black", dim(MG94.nonclock.filtered)[2])
col.color[((MG94.nonclock.filtered - MG94.Force.nonclock.filtered)[2,] / MG94.nonclock.filtered[1]) < improvement.lmt] <- "red"
points(x = colSums(MG94.Force.nonclock.filtered[10:21, ]), y = MG94.nonclock.filtered[8, ],
       type = "p", col = col.color, bg = col.color)
legend("topright", 
       c(paste("lnL improvement per site > ", toString(improvement.lmt), sep = ""),
         paste("lnL improvement per site < ", toString(improvement.lmt), sep = "")),
       lty = c(1, 1), 
       lwd = c(2.5, 2.5),
       col = c("black", "red"))
title("MG94 nonclock")

# lnL improvement per site
((MG94.nonclock.filtered - MG94.Force.nonclock.filtered)[2,] / MG94.nonclock.filtered[1])
```

MG94 clock case
```{r}
improvement.lmt <- 0.4
plot(colSums(MG94.Force.clock.filtered[10:21, ]), MG94.clock.filtered[8, ],
     type = "n", xlab = "Total branch length", ylab = "Tau" )
col.color <- rep("black", dim(MG94.clock.filtered)[2])
col.color[((MG94.clock.filtered - MG94.Force.clock.filtered)[2,] / MG94.clock.filtered[1]) < improvement.lmt] <- "red"
points(x = colSums(MG94.Force.clock.filtered[10:21, ]), y = MG94.clock.filtered[8, ],
       type = "p", col = col.color, bg = col.color)
legend("topright", 
       c(paste("lnL improvement per site > ", toString(improvement.lmt), sep = ""),
         paste("lnL improvement per site < ", toString(improvement.lmt), sep = "")),
       lty = c(1, 1), 
       lwd = c(2.5, 2.5),
       col = c("black", "red"))
title("MG94 clock")

# lnL improvement per site
((MG94.clock.filtered - MG94.Force.clock.filtered)[2,] / MG94.clock.filtered[1])
```


OK, the MG94 nonclock long branch lengths are suspecious. It seems that 
the first four branches carry most of the total length. What if plot without those 
branches?

MG94 nonclock case without first four branches:
(N0, N1), (N0,kluyveri), (N1,N2), (N1,castellii) are excluded
```{r}
improvement.lmt <- 0.16
plot(colSums(MG94.Force.nonclock.filtered[14:21, ]), MG94.nonclock.filtered[8, ],
     type = "n", xlab = "Partial branch length", ylab = "Tau" )
col.color <- rep("black", dim(MG94.nonclock.filtered)[2])
col.color[((MG94.nonclock.filtered - MG94.Force.nonclock.filtered)[2,] / MG94.nonclock.filtered[1]) < improvement.lmt] <- "red"
points(x = colSums(MG94.Force.nonclock.filtered[14:21, ]), y = MG94.nonclock.filtered[8, ],
       type = "p", col = col.color, bg = col.color)
legend("topright", 
       c(paste("lnL improvement per site > ", toString(improvement.lmt), sep = ""),
         paste("lnL improvement per site < ", toString(improvement.lmt), sep = "")),
       lty = c(1, 1), 
       lwd = c(2.5, 2.5),
       col = c("black", "red"))
title("MG94 nonclock 4 branches removed")

# lnL improvement per site
((MG94.nonclock.filtered - MG94.Force.nonclock.filtered)[2,] / MG94.nonclock.filtered[1])
```


=========================================


Now, plot posterior expected Number of geneconv events from paralog 1 to paralog2 / paralog2 to paralog 1 of each pair

Each plot is for each pair of paralogs under one model with each point representing one branch

```{r}

# First read in descriptions of the cerevisiae genes.
description <- as.list(readLines("/Users/xji3/Genconv/NewClusterPackRun/cerevisiae_genes_description.txt"))
names(description) <- readLines("/Users/xji3/Genconv/NewClusterPackRun/cerevisiae_genes.txt")

for (i in 1:36){

#HKY nonclock

  rows <- 35:44
  paralog <- strsplit(colnames(HKY.nonclock.filtered)[i], split = "_")[[1]]
  plot(HKY.nonclock.filtered[rows, i],  HKY.nonclock.filtered[rows + 12, i],
       xlab = paste(paralog[1], paralog[2], sep = " -> "),
       ylab = paste(paralog[2], paralog[1], sep = " -> "),
       main = paste(colnames(HKY.nonclock.filtered)[i], " HKY Non clock"))
  abline(a = 0, b = 1)


#HKY clock

  paralog <- strsplit(colnames(HKY.clock.filtered)[i], split = "_")[[1]]
  plot(HKY.clock.filtered[rows, i],  HKY.clock.filtered[rows + 12, i],
       xlab = paste(paralog[1], paralog[2], sep = " -> "),
       ylab = paste(paralog[2], paralog[1], sep = " -> "),
       main = paste(colnames(HKY.clock.filtered)[i], " HKY Clock"))
  abline(a = 0, b = 1)

#MG94 Non-clock

  rows <- 36:45
  paralog <- strsplit(colnames(MG94.nonclock.filtered)[i], split = "_")[[1]]
  plot(MG94.nonclock.filtered[rows, i],  MG94.nonclock.filtered[rows + 12, i],
       xlab = paste(paralog[1], paralog[2], sep = " -> "),
       ylab = paste(paralog[2], paralog[1], sep = " -> "),
       main = paste(colnames(MG94.nonclock.filtered)[i], " MG94 Non clock"))
  abline(a = 0, b = 1)

#MG94 clock

  paralog <- strsplit(colnames(MG94.clock.filtered)[i], split = "_")[[1]]
  plot(MG94.clock.filtered[rows, i],  MG94.clock.filtered[rows + 12, i],
       xlab = paste(paralog[1], paralog[2], sep = " -> "),
       ylab = paste(paralog[2], paralog[1], sep = " -> "),
       main = paste(colnames(MG94.clock.filtered)[i], " MG94 Clock"))
  abline(a = 0, b = 1)

# Now show the description from cerevisiae genes of this pair
print(description[paralog[1]][[1]])
print(description[paralog[2]][[1]])
}
```


=========================================


Now, plot histogram of posterior expected Number of geneconv events from paralog 1 to paralog2 / paralog2 to paralog 1 of each pair

Each plot is for one model. Each point contains the sum of expected number of directional IGC over all branches.

```{r}
# HKY nonclock
rows <- 35:44
plot(rowSums(HKY.nonclock.filtered[rows, 1:36]),
     rowSums(HKY.nonclock.filtered[rows + 12, 1:36]),
       xlab = paste("paralog 1", "paralog 2", sep = " -> "),
       ylab = paste("paralog 2", "paralog 1", sep = " -> "),
       main = paste("All pairs HKY nonclock"))
abline(a = 0, b = 1)

# HKY clock
plot(rowSums(HKY.clock.filtered[rows, 1:36]),
     rowSums(HKY.clock.filtered[rows + 12, 1:36]),
       xlab = paste("paralog 1", "paralog 2", sep = " -> "),
       ylab = paste("paralog 2", "paralog 1", sep = " -> "),
       main = paste("All pairs HKY clock"))
abline(a = 0, b = 1)

# MG94 nonclock
rows <- 36:45
plot(rowSums(MG94.nonclock.filtered[rows, 1:36]),
     rowSums(MG94.nonclock.filtered[rows + 12, 1:36]),
       xlab = paste("paralog 1", "paralog 2", sep = " -> "),
       ylab = paste("paralog 2", "paralog 1", sep = " -> "),
       main = paste("All pairs MG94 nonclock"))
abline(a = 0, b = 1)

# MG94 clock
plot(rowSums(MG94.clock.filtered[rows, 1:36]),
     rowSums(MG94.clock.filtered[rows + 12, 1:36]),
       xlab = paste("paralog 1", "paralog 2", sep = " -> "),
       ylab = paste("paralog 2", "paralog 1", sep = " -> "),
       main = paste("All pairs MG94 clock"))
abline(a = 0, b = 1)
```


=========================================


Now, calculate the LR test statistics of adding one more directional tau parameter

```{r}
# HKY nonclock
Tlr.HKY.nonclock <- 2 * (Dir_HKY_nonclock_summary[2, ] - HKY_nonclock_summary[2, ])
# HKY clock
Tlr.HKY.clock <- 2 * (Dir_HKY_clock_summary[2, ] - HKY_clock_summary[2, ])

# MG94 nonclock
Tlr.MG94.nonclock <- 2 * (Dir_MG94_nonclock_summary[2, ] - MG94_nonclock_summary[2, ])
# MG94 clock
Tlr.MG94.clock <- 2 * (Dir_MG94_clock_summary[2, ] - MG94_clock_summary[2, ])

Tlr.HKY.nonclock
Tlr.HKY.clock
Tlr.MG94.nonclock
Tlr.MG94.clock
```


